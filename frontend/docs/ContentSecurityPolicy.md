# Content Security Policy (CSP) Documentation

This document outlines the Content Security Policy implemented in the Deployment Portal application and explains the exceptions required for proper functionality.

## Policy Overview

Our application implements the following core policy directives:

```
default-src 'self';
style-src 'self' 'unsafe-inline';
img-src 'self' data:;
connect-src 'self' http://localhost:5000;
script-src 'self';
font-src 'self';
```

## Exception Justifications

### 1. `style-src 'self' 'unsafe-inline'`

**Reason:** Material-UI (MUI) relies on Emotion for styling, which injects CSS using inline styles. Without `'unsafe-inline'`, MUI components would lose all styling and appear broken.

**Alternatives considered:**
- Using a nonce-based approach: Not fully compatible with the way Emotion injects styles.
- Using hashes: Impractical due to the dynamic nature of Emotion-generated styles.

**Mitigation:**
- We limit the scope of 'unsafe-inline' to style-src only.
- We use MUI's `StyledEngineProvider` with caching to minimize the number of inline styles.

### 2. `img-src 'self' data:`

**Reason:** Required for:
- Loading SVG icons within the application
- Displaying user avatars and other dynamically generated images
- Supporting the ThemeToggler component which uses data URIs

**Mitigation:**
- All image data URIs are generated by trusted application code, not from user input.

### 3. `connect-src 'self' http://localhost:5000`

**Reason:** During development, the backend API runs on a separate origin (localhost:5000).

**Production behavior:**
- In production, this will be adjusted to only include the specific API endpoints needed.

## Implementation Details

Our CSP is implemented using the `react-helmet-async` package, which sets HTTP headers at the React component level. This allows for:

1. Dynamic adjustment of policies based on environment (dev/prod)
2. Component-specific policy modifications when necessary
3. Clear management of security policies within the application code

## Security Considerations

1. **XSS Protection:** Despite the 'unsafe-inline' exception for styles, the application maintains strong XSS protection by:
   - Not allowing inline scripts (`script-src 'self'` only)
   - Strict input validation and sanitization
   - Using React's built-in XSS protections

2. **Regular Auditing:** The CSP configuration is regularly audited to identify opportunities to tighten restrictions.

3. **CSP Reporting:** In production, we implement CSP reporting to monitor for potential violations.

## Future Improvements

1. Explore using the trusted-types policy to further harden against DOM-based XSS.
2. Investigate alternatives to 'unsafe-inline' for styles as browser support improves.
3. Implement more granular connect-src controls in production.
